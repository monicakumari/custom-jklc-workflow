(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event;var $html=Alfresco.util.encodeHTML,$siteURL=Alfresco.util.siteURL;Alfresco.component.TaskList=function(htmlId){Alfresco.component.TaskList.superclass.constructor.call(this,"Alfresco.component.TaskList",htmlId,["button","menu","container","datasource","datatable","paginator","json","history"]);YAHOO.Bubbling.on("filterChanged",this.onFilterChanged,this);return this};YAHOO.extend(Alfresco.component.TaskList,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.component.TaskList,Alfresco.action.WorkflowActions);YAHOO.lang.augmentObject(Alfresco.component.TaskList.prototype,{options:{hiddenTaskTypes:[],filterParameters:[],maxItems:50},onReady:function DL_onReady(){var url=Alfresco.constants.PROXY_URI+"api/task-instances?authority="+encodeURIComponent(Alfresco.constants.USERNAME)+"&properties="+["bpm_priority","bpm_status","bpm_dueDate","bpm_description"].join(",")+"&exclude="+this.options.hiddenTaskTypes.join(",");this.widgets.pagingDataTable=new Alfresco.util.DataTable({dataTable:{container:this.id+"-tasks",columnDefinitions:[{key:"id",sortable:false,formatter:this.bind(this.renderCellIcons),width:40},{key:"title",sortable:false,formatter:this.bind(this.renderCellTaskInfo)},{key:"name",sortable:false,formatter:this.bind(this.renderCellActions),width:200}],config:{MSG_EMPTY:this.msg("message.noTasks")}},dataSource:{url:url,defaultFilter:{filterId:"workflows.active"},filterResolver:this.bind(function(filter){return this.createFilterURLParameters(filter,this.options.filterParameters)})},paginator:{config:{containers:[this.id+"-paginator"],rowsPerPage:this.options.maxItems}}})},onFilterChanged:function BaseFilter_onFilterChanged(layer,args){var filter=Alfresco.util.cleanBubblingObject(args[1]);Dom.get(this.id+"-filterTitle").innerHTML=$html(this.msg("filter."+filter.filterId+(filter.filterData?"."+filter.filterData:""),filter.filterData))},renderCellIcons:function TL_renderCellIcons(elCell,oRecord,oColumn,oData){var priority=oRecord.getData("properties")["bpm_priority"],priorityMap={"1":"high","2":"medium","3":"low"},priorityKey=priorityMap[priority+""],pooledTask=oRecord.getData("isPooled");var desc='<img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/priority-"+priorityKey+'-16.png" title="'+this.msg("label.priority",this.msg("priority."+priorityKey))+'"/>';if(pooledTask){desc+='<br/><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/pooled-task-16.png" title="'+this.msg("label.pooledTask")+'"/>'}elCell.innerHTML=desc},renderCellTaskInfo:function TL_renderCellTaskInfo(elCell,oRecord,oColumn,oData){var workflowInstance=oRecord.getData("workflowInstance");var packageNodeRef=workflowInstance["package"];Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"slingshot/node/"+packageNodeRef.replace("://","/"),successCallback:{fn:function(res){var result=eval("("+res.serverResponse.responseText+")");if(result.children.length>0){var docNodeRef=result.children[0].nodeRef;this.callFunction(elCell,oRecord,oColumn,oData,docNodeRef)}else{this.callFunction(elCell,oRecord,oColumn,oData,"")}},scope:this},failureCallback:{fn:function(res){console.log("ERROR :"+res)},scope:this}})},callFunction:function callFunction(elCell,oRecord,oColumn,oData,docNodeRef){var taskId=oRecord.getData("id"),message=$html(oRecord.getData("properties")["bpm_description"]),dueDateStr=oRecord.getData("properties")["bpm_dueDate"],dueDate=dueDateStr?Alfresco.util.fromISO8601(dueDateStr):null,workflowInstance=oRecord.getData("workflowInstance"),startedDate=workflowInstance.startDate?Alfresco.util.fromISO8601(workflowInstance.startDate):null,type=$html(oRecord.getData("title")),status=$html(oRecord.getData("properties")["bpm_status"]),assignee=oRecord.getData("owner"),description=$html(oRecord.getData("description")),initiator;if(workflowInstance.initiator){initiator=$html(workflowInstance.initiator.firstName)}var data=oRecord.getData();if(data.propertyLabels&&Alfresco.util.isValueSet(data.propertyLabels.bpm_status,false)){status=data.propertyLabels.bpm_status}if(message==type){message=this.msg("workflow.no_message")}var href;if(oRecord.getData("isEditable")){href=$siteURL("task-edit?taskId="+taskId+"&referrer=tasks&myTasksLinkBack=true")+'" class="theme-color-1" title="'+this.msg("link.editTask");if(docNodeRef){href=$siteURL("task-edit?taskId="+taskId+"&nodeRef="+docNodeRef)+'" class="theme-color-1" title="'+this.msg("link.editTask")}}else{href=$siteURL("task-details?taskId="+taskId+"&referrer=tasks&myTasksLinkBack=true")+'" class="theme-color-1" title="'+this.msg("link.viewTask")}var info='<h3><a href="'+href+'">'+message+"</a></h3>";info+='<div class="due"><label>'+this.msg("label.due")+":</label><span>"+(dueDate?Alfresco.util.formatDate(dueDate,"longDate"):this.msg("label.none"))+"</span></div>";info+='<div class="started"><label>'+this.msg("label.started")+":</label><span>"+(startedDate?Alfresco.util.formatDate(startedDate,"longDate"):this.msg("label.none"))+"</span></div>";if(!workflowInstance.isActive){var endedDate=workflowInstance.endDate?Alfresco.util.fromISO8601(workflowInstance.endDate):null;info+='<div class=ended"><label>'+this.msg("label.ended")+":</label><span>"+(endedDate?Alfresco.util.formatDate(endedDate,"longDate"):this.msg("label.none"))+"</span></div>"}info+='<div class="status"><label>'+this.msg("label.status")+":</label><span>"+status+"</span></div>";info+='<div class="type"><label>'+this.msg("label.type",type)+":</label><span>"+type+"</span></div>";info+='<div class="description"><label>'+this.msg("label.description")+":</label><span>"+description+"</span></div>";if(initiator){info+='<div class="initiator"><label>'+this.msg("label.initiator")+":</label><span>"+initiator+"</span></div>"}if(!assignee||!assignee.userName){info+='<div class="unassigned"><span class="theme-bg-color-5 theme-color-5 unassigned-task">'+this.msg("label.unassignedTask")+"</span></div>"}elCell.innerHTML=info},renderCellActions:function TL_renderCellActions(elCell,oRecord,oColumn,oData){if(oRecord.getData("isEditable")){var workflowInstance=oRecord.getData("workflowInstance");var packageNodeRef=workflowInstance["package"];Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"slingshot/node/"+packageNodeRef.replace("://","/"),successCallback:{fn:function(res){var result=eval("("+res.serverResponse.responseText+")");if(result.children.length>0){var docNodeRef=result.children[0].nodeRef;this.createAction(elCell,this.msg("link.editTask"),"task-edit-link",$siteURL("task-edit?taskId="+oRecord.getData("id")+"&nodeRef="+docNodeRef))}else{this.createAction(elCell,this.msg("link.editTask"),"task-edit-link",$siteURL("task-edit?taskId="+oRecord.getData("id")+"&referrer=tasks&myTasksLinkBack=true"))}},scope:this},failureCallback:{fn:function(res){console.log("ERROR :"+res)},scope:this}})}this.createAction(elCell,this.msg("link.viewTask"),"task-view-link",$siteURL("task-details?taskId="+oRecord.getData("id")+"&referrer=tasks&myTasksLinkBack=true"));this.createAction(elCell,this.msg("link.viewWorkflow"),"workflow-view-link",$siteURL("workflow-details?workflowId="+oRecord.getData("workflowInstance").id+"&taskId="+oRecord.getData("id")+"&referrer=tasks&myTasksLinkBack=true"))}},true)})();