(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event,Selector=YAHOO.util.Selector;var $html=Alfresco.util.encodeHTML,$siteURL=Alfresco.util.siteURL;Alfresco.dashlet.MyTasks=function MyTasks_constructor(htmlId){Alfresco.dashlet.MyTasks.superclass.constructor.call(this,"Alfresco.dashlet.MyTasks",htmlId,["button","container","datasource","datatable","paginator","history","animation"]);this.services.preferences=new Alfresco.service.Preferences();return this};YAHOO.extend(Alfresco.dashlet.MyTasks,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.dashlet.MyTasks,Alfresco.action.WorkflowActions);YAHOO.lang.augmentObject(Alfresco.dashlet.MyTasks.prototype,{PREFERENCES_TASKS_DASHLET:"",PREFERENCES_TASKS_DASHLET_FILTER:"",options:{hiddenTaskTypes:[],maxItems:50,filters:{}},onReady:function MyTasks_onReady(){this.widgets.filterMenuButton=Alfresco.util.createYUIButton(this,"filters",this.onFilterSelected,{type:"menu",menu:"filters-menu",lazyloadmenu:false});this.PREFERENCES_TASKS_DASHLET=this.services.preferences.getDashletId(this,"tasks");this.PREFERENCES_TASKS_DASHLET_FILTER=this.PREFERENCES_TASKS_DASHLET+".filter";var prefs=this.services.preferences.get();var filter=Alfresco.util.findValueByDotNotation(prefs,this.PREFERENCES_TASKS_DASHLET_FILTER,"activeTasks");filter=this.options.filters.hasOwnProperty(filter)?filter:"activeTasks";this.widgets.filterMenuButton.set("label",this.msg("filter."+filter)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filterMenuButton.value=filter;Dom.removeClass(Selector.query(".toolbar div",this.id,true),"hidden");var webscript=YAHOO.lang.substitute("api/task-instances?authority={authority}&properties={properties}&exclude={exclude}",{authority:encodeURIComponent(Alfresco.constants.USERNAME),properties:["bpm_priority","bpm_status","bpm_dueDate","bpm_description"].join(","),exclude:this.options.hiddenTaskTypes.join(",")});this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+webscript,filterResolver:this.bind(function(){var filter=this.widgets.filterMenuButton.value;var filterParameters=this.options.filters[filter];return this.substituteParameters(filterParameters)||""})},dataTable:{container:this.id+"-tasks",columnDefinitions:[{key:"isPooled",sortable:false,formatter:this.bind(this.renderCellIcons),width:24},{key:"title",sortable:false,formatter:this.bind(this.renderCellTaskInfo)},{key:"name",sortable:false,formatter:this.bind(this.renderCellActions),width:45}],config:{MSG_EMPTY:this.msg("message.noTasks")}},paginator:{history:false,hide:false,config:{containers:[this.id+"-paginator"],template:"{FirstPageLink} {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink}",firstPageLinkLabel:"&lt;&lt;",previousPageLinkLabel:"&lt;",nextPageLinkLabel:"&gt;",lastPageLinkLabel:"&gt;&gt;",pageReportTemplate:this.msg("pagination.template.page-report"),rowsPerPage:this.options.maxItems}}});var me=this,dataTable=this.widgets.alfrescoDataTable.getDataTable(),original_doBeforeLoadData=dataTable.doBeforeLoadData;dataTable.doBeforeLoadData=function MyTasks_doBeforeLoadData(sRequest,oResponse,oPayload){if(oResponse.results.length===0){Dom.addClass(this.configs.paginator.getContainerNodes(),"hidden")}else{Dom.removeClass(this.configs.paginator.getContainerNodes(),"hidden")}if(oResponse.results.length===0){oResponse.results.unshift({isInfo:true,title:me.msg("empty.title"),description:me.msg("empty.description")})}return original_doBeforeLoadData.apply(this,arguments)}},onFilterSelected:function MyTasks_onFilterSelected(p_sType,p_aArgs){var menuItem=p_aArgs[1];if(menuItem){this.widgets.alfrescoDataTable.currentSkipCount=0;this.widgets.filterMenuButton.set("label",menuItem.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filterMenuButton.value=menuItem.value;var parameters=this.substituteParameters(this.options.filters[menuItem.value],{});this.widgets.alfrescoDataTable.loadDataTable(parameters);this.services.preferences.set(this.PREFERENCES_TASKS_DASHLET_FILTER,menuItem.value)}},renderCellIcons:function MyTasks_onReady_renderCellIcons(elCell,oRecord,oColumn,oData){var data=oRecord.getData(),desc="";if(data.isInfo){oColumn.width=52;Dom.setStyle(elCell,"width",oColumn.width+"px");Dom.setStyle(elCell.parentNode,"width",oColumn.width+"px");desc='<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/help-task-bw-32.png" />'}else{var priority=data.properties.bpm_priority,priorityMap={"1":"high","2":"medium","3":"low"},priorityKey=priorityMap[priority+""],pooledTask=data.isPooled;desc='<img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/priority-"+priorityKey+'-16.png" title="'+this.msg("label.priority",this.msg("priority."+priorityKey))+'"/>';if(pooledTask){desc+='<br/><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/pooled-task-16.png" title="'+this.msg("label.pooledTask")+'"/>'}}elCell.innerHTML=desc},renderCellTaskInfo:function MyTasks_onReady_renderCellTaskInfo(elCell,oRecord,oColumn,oData){var data=oRecord.getData(),desc="";if(data.isInfo){desc+='<div class="empty"><h3>'+data.title+"</h3>";desc+="<span>"+data.description+"</span></div>";elCell.innerHTML=desc}else{var packageNodeRef=data.workflowInstance["package"];Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"slingshot/node/"+packageNodeRef.replace("://","/"),successCallback:{fn:function(res){var result=eval("("+res.serverResponse.responseText+")");if(result.children.length>0){var docNodeRef=result.children[0].nodeRef;this.callFunction(elCell,oRecord,oColumn,oData,data,docNodeRef)}else{this.callFunction(elCell,oRecord,oColumn,oData,data,"")}},scope:this},failureCallback:{fn:function(res){console.log("ERROR :"+res)},scope:this}})}},callFunction:function callFunction(elCell,oRecord,oColumn,oData,data,docNodeRef){var taskId=data.id,message=data.properties.bpm_description,dueDateStr=data.properties.bpm_dueDate,dueDate=dueDateStr?Alfresco.util.fromISO8601(dueDateStr):null,today=new Date(),type=data.title,status=data.properties.bpm_status,assignee=data.owner;if(data.propertyLabels&&Alfresco.util.isValueSet(data.propertyLabels.bpm_status,false)){status=data.propertyLabels.bpm_status}if(message==type){message=this.msg("workflow.no_message")}var href;if(data.isEditable){href=$siteURL("task-edit?taskId="+taskId)+'" class="theme-color-1" title="'+this.msg("title.editTask");if(docNodeRef){href=$siteURL("task-edit?taskId="+taskId+"&nodeRef="+docNodeRef)+'" class="theme-color-1" title="'+this.msg("title.editTask")}}else{href=$siteURL("task-details?taskId="+taskId)+'" class="theme-color-1" title="'+this.msg("title.viewTask")}var messageDesc='<h3><a href="'+href+'">'+$html(message)+"</a></h3>",dateDesc=dueDate?'<h4><span class="'+(today>dueDate?"task-delayed":"")+'" title="'+this.msg("title.dueOn",Alfresco.util.formatDate(dueDate,"longDate"))+'">'+Alfresco.util.formatDate(dueDate,"longDate")+"</span></h4>":"",statusDesc='<div title="'+this.msg("title.taskSummary",type,status)+'">'+this.msg("label.taskSummary",type,status)+"</div>",unassignedDesc="";if(!assignee||!assignee.userName){unassignedDesc='<span class="theme-bg-color-5 theme-color-5 unassigned-task">'+this.msg("label.unassignedTask")+"</span>"}desc=messageDesc+dateDesc+statusDesc+unassignedDesc;elCell.innerHTML=desc},renderCellActions:function MyTasks_onReady_renderCellActions(elCell,oRecord,oColumn,oData){var data=oRecord.getData(),desc="";if(data.isInfo){oColumn.width=0;Dom.setStyle(elCell,"width",oColumn.width+"px");Dom.setStyle(elCell.parentNode,"width",oColumn.width+"px")}else{if(data.isEditable){var workflowInstance=oRecord.getData("workflowInstance");var packageNodeRef=workflowInstance["package"];Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"slingshot/node/"+packageNodeRef.replace("://","/"),successCallback:{fn:function(res){var result=eval("("+res.serverResponse.responseText+")");if(result.children.length>0){var docNodeRef=result.children[0].nodeRef;desc+='<a href="'+$siteURL("task-edit?taskId="+data.id+"&nodeRef="+docNodeRef)+'" class="edit-task" title="'+this.msg("title.editTask")+'">&nbsp;</a>'}else{desc+='<a href="'+$siteURL("task-edit?taskId="+data.id)+'" class="edit-task" title="'+this.msg("title.editTask")+'">&nbsp;</a>'}desc+='<a href="'+$siteURL("task-details?taskId="+data.id)+'" class="view-task" title="'+this.msg("title.viewTask")+'">&nbsp;</a>';elCell.innerHTML=desc},scope:this},failureCallback:{fn:function(res){console.log("ERROR :"+res)},scope:this}})}else{desc+='<a href="'+$siteURL("task-details?taskId="+data.id)+'" class="view-task" title="'+this.msg("title.viewTask")+'">&nbsp;</a>';elCell.innerHTML=desc}}}})})();